#!/bin/bash
# Toggle NetSkope VPN (system service + user service + tray)

set -euo pipefail

BLUE="\033[1;34m"
GREEN="\033[1;32m"
RESET="\033[0m"

usage() {
    echo -e "${BLUE}Usage: $0 [start|stop|restart]${RESET}"
    echo -e "${BLUE}  start   - Start the NetSkope VPN services${RESET}"
    echo -e "${BLUE}  stop    - Stop the NetSkope VPN services${RESET}"
    echo -e "${BLUE}  restart - Restart the NetSkope VPN services${RESET}"
}

start() {
    echo -e "${BLUE}Starting system service${RESET}"
    sudo systemctl start stagentd.service

    echo -e "${BLUE}Starting user service${RESET}"
    systemctl --user start stagentapp.service

    echo -e "${BLUE}Starting ui (tray)${RESET}"
    dex /usr/share/applications/stagentui.desktop

    echo -e "${GREEN}NetSkope VPN started${RESET}"
}

stop() {
    echo -e "${BLUE}Stopping system service${RESET}"
    sudo systemctl stop stagentd.service

    echo -e "${BLUE}Stopping user service${RESET}"
    systemctl --user stop stagentapp.service

    echo -e "${BLUE}Stopping ui (tray)${RESET}"
    killall --quiet /opt/netskope/stagent/stAgentUI || true

    echo -e "${GREEN}NetSkope VPN stopped${RESET}"
}

restart() {
    echo -e "${BLUE}Restarting NetSkope VPN...${RESET}"
    stop
    start
}

# Function to disable NetSkope, because this thing re-enables itself on start
disable_services() {
    echo -e "${BLUE}Disabling system services${RESET}"
    sudo systemctl disable stagentd.service

    echo -e "${BLUE}Disabling user services${RESET}"
    systemctl --user disable stagentapp.service
    # On my laptop, the user service is enabled globally, so we need to disable it globally
    sudo systemctl disable --global stagentapp.service
}

# Check if a parameter was provided
if [ $# -ge 1 ]; then
    case "$1" in
        start)
            start
            disable_services
            ;;
        stop)
            stop
            disable_services
            ;;
        restart)
            restart
            disable_services
            ;;
        *)
            echo -e "${BLUE}Invalid option. Usage: $0 [start|stop|restart]${RESET}"
            exit 1
            ;;
    esac
else
    echo -e "${BLUE}No operation provided.${RESET}"
    usage
    exit 1
fi
